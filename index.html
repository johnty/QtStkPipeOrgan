<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>QtStkPipeOrgan by johnty</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">QtStkPipeOrgan</h1>
      <h2 class="project-tagline">Realtime Pipe Organ Implementation in STK</h2>
      <a href="https://github.com/johnty/QtStkPipeOrgan" class="btn">View on GitHub</a>
      <a href="https://github.com/johnty/QtStkPipeOrgan/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/johnty/QtStkPipeOrgan/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="a-realtime-pipe-organ-instrument-using-qt-and-stk" class="anchor" href="#a-realtime-pipe-organ-instrument-using-qt-and-stk" aria-hidden="true"><span class="octicon octicon-link"></span></a>A Realtime Pipe Organ Instrument using QT and STK</h1>

<p>Johnty Wang (<a href="mailto:johnty.wang@mail.mcgill.ca">johnty.wang@mail.mcgill.ca</a>)</p>

<p>Project Report for MUMT618, Fall 2015. </p>

<p>Instructor: Prof. Gary Scavone</p>

<h2>
<a id="introduction" class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h2>

<ul>
<li><p>This project report describes the implementation of a pipe organ instrument in C++ using the STK, RtAudio and QT libraries. </p></li>
<li><p>The goal is a cross-platform C++ GUI application that simulates basic types of common organ pipes, the: flue and reed.</p></li>
<li><p>The instrument appears as a virtual MIDI device that can be controlled by hardware controllers: note-on/off messages control pitches while program changes allow toggling of stops. </p></li>
<li><p>Using a single MIDI keyboard, the behaviour of a small chamber organ can be simulated. </p></li>
<li>
<p>The rest of the report consists of the following sections: </p>

<ol>
<li>An introduction and background on the physical layout and relevant parts of a pipe organ. </li>
<li>A discussion on how various parts of the organ may be modelled.</li>
<li>Implementation details of the C++ application and a description of the available demonstration so far.</li>
</ol>
</li>
</ul>

<p align="center">
<img src="img/ryerson.jpg" alt="Ryerson Organ"><br>
The organ at Ryerson United Church, Vancouver BC. (photo: Johnty Wang)
</p>

<hr>

<h2>
<a id="background" class="anchor" href="#background" aria-hidden="true"><span class="octicon octicon-link"></span></a>Background</h2>

<ul>
<li><p>Despite having a chromatic keyboard, the organ is a wind instrument and very different to most keyboard instruments. (Exceptions include the piano accordion and melodica)</p></li>
<li><p>Unlike other wind instruments, the air is not supplied by the player directly. Traditionally created using manual bellows; nowadays digital blowers. The following image shows a "treadmill" that is typical of old church organs before steam or electric blowers. Smaller organs had bellows that could be pumped by the knees of the player, or non-playing hand in the case of really small "regal organs" (Clarke).</p></li>
</ul>

<p align="center">
<img src="https://upload.wikimedia.org/wikipedia/commons/d/d7/HalberstadtBurchardiChurchBellows.jpg" alt="Organ blower treadmills"><br>
(img src: wikipedia)</p>

<h3>
<a id="flue-and-reed-pipes" class="anchor" href="#flue-and-reed-pipes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flue and Reed Pipes</h3>

<p>There are two main kinds of pipes on an organ.</p>

<h4>
<a id="flue-pipes" class="anchor" href="#flue-pipes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flue Pipes</h4>

<ul>
<li>
<p>The flue pipe is somewhat similar in operation to a flute</p>

<p align="center">
<img src="https://upload.wikimedia.org/wikipedia/commons/0/01/PSM_V40_D651_Flue_stop_organ_pipes.jpg" alt="flue pipes"><br>
(img src: Clarke/wikipedia)</p>
</li>
<li><p>Frequency is tuned by length of pipe</p></li>
<li>The metal pipes are mostly cylindrical/conical, while the wooden ones are rectangular in cross section. However, more exotic shapes exist:</li>
</ul>

<p align="center">
<img src="img/pipeshapes.jpg" alt="pipe shapes"><br>
(img src: Clarke)</p>

<h4>
<a id="reed-pipes" class="anchor" href="#reed-pipes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reed Pipes</h4>

<ul>
<li>
<p>The reed pipe is more like a clarinet (or very large single reed harmonica, perhaps). There is a small spring attached to the read that allows tuning of its fundamental frequency. The length of the pipe is tuned to this frequency.
<img src="img/reedpipe.jpg" alt="wind chest"></p>

<p>(Clarke 1877)</p>
</li>
</ul>

<h3>
<a id="pipe-organization" class="anchor" href="#pipe-organization" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pipe Organization</h3>

<ul>
<li>The pipes are grouped together in a row (called "stops" or "ranks"), and connected to the air source or "wind chest".</li>
</ul>

<p><img src="img/windchests.png" alt="wind chest">
<img src="img/windchests2.png" alt="cross sectional"></p>

<p>(Clarke 1877)</p>

<ul>
<li><p>If a stop is active, there is a mechanical (or electrical) link between the keyboard note, and the valve associated with a particular pipe.</p></li>
<li><p>Stops that are "unique" to the instrument are called principles or diapason, while others often bear the names of instruments the stop is supposed to imitate. Mutation stops don't sound at the fundamental note, but instead some harmonic of the fundamental and is generally used in combination with other stops to reinforce partials of a sound. (e.g. for the "Cornet" stop, a base flute stop is combined with other stops tuned to the harmonic series).</p></li>
<li><p>A large church organ can have thousands of pipes. (e.g. at St Andrews &amp; St Paul, Montreal where we sing, there are around 7000 pipes)</p></li>
</ul>

<h3>
<a id="adjusting-the-sound" class="anchor" href="#adjusting-the-sound" aria-hidden="true"><span class="octicon octicon-link"></span></a>Adjusting the Sound</h3>

<ul>
<li><p>Control of individual pipe by adjusting its physical parameters (Voicing)</p></li>
<li><p>Choosing combinations of stops to be used (Registration). On mechanical systems it requires the manual selection and deselection of many controls, and often another person is employed for the task for complex setups. In electronic control systems with memory the task can be actuated using preset buttons.</p></li>
</ul>

<h3>
<a id="control-systeminputs" class="anchor" href="#control-systeminputs" aria-hidden="true"><span class="octicon octicon-link"></span></a>Control System/Inputs</h3>

<ul>
<li><p>Keyboard: 6 octaves of chromatic notes,. Set of 3-6 depending on instrument. Referred to as manuals.</p></li>
<li><p>Pedalboard: 1 ~ 3 octaves of chromatic notes, activated by the foot. Traditionally assigned to large, bass pipes.</p></li>
<li><p>Stops: draw tabs that activate each set of pipes</p></li>
<li><p>Foot switches: discrete buttons for activating settings, swell shutters that control volume by adjusting blinds in which certain pipes are housed. This usually applies to the "swell" and "choir" groups of stops.</p></li>
<li><p>Couplers: these toggles allowed the input of one manual to control stops associated with another. For example, if one of the keyboard manuals is coupled to the pedalboard, pressing the keys would activate the notes of the stops normally associated with the pedals. They can also "couple" the action of other controllers such as the footpedals for swell and choir shutters (e.g. pressing one pedal can control both shutters, etc).</p></li>
</ul>

<p>Traditionally, everything is linked mechanically (Tracker organs). This allowed more direct control of the lever mechanisms for controlling the flow/stop of air, but also requires larger input forces as more stops are active. Following is an image of the complex mechanical matrix of a tracker organ system.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/9/9b/Pipe_organ_tracker_action.jpg" alt="Tracker Organ"></p>

<p>Over time, as instruments got larger, pneumatic actuators, akin to "fly-by-wire" aircraft control systems, eliminated the limitation of the tracker action by decoupling the input at the keyboard with the actual stop mechanism controlling the airflow.</p>

<p>Most modern organs are digitally controlled. This allows more flexible coupling, and quick recall of complex combinations. This also means the console does not have to be located in fixed place. (For example, the Ryerson organ shown at the beginning of this document can be carted around the sancturary and wired to the control system via a network cable.</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/7/74/Organ_Console%2C_Holy_Trinity%2C_Buffalo.jpeg" alt="Holy Trinity Organ Console"></p>

<p>(Organ console at Holy Trinity, Buffalo. src: wikipedia. The round buttons on either side of the keyboards are the stop toggles. The two rows of vertical switches above the keyboard are the couplers. The round buttons between keyboard manuals are for loading combination presets. The two depressed foot pedals in the centre are the swell and choir shutter controllers for controlling the volume of those sets of stops, and the "crescendo" pedal allows stops to be incrementally activated as it is depressed further, creating increasingly louder and fuller sounds.)</p>

<h4>
<a id="the-organ-is-probably-the-worlds-first-synthesizer" class="anchor" href="#the-organ-is-probably-the-worlds-first-synthesizer" aria-hidden="true"><span class="octicon octicon-link"></span></a><em>The Organ is probably the world's first "synthesizer"</em>
</h4>

<p>In the sense that it allows one to re-map the inputs to create different outputs. It also "synthesized" various other instrument sounds by imitation, including the "Vox Humana" stop which is a reed stop has some similar characteristics to the human vocal tract.</p>

<h4>
<a id="can-fully-reproduce-a-performance-from-recorded-signals" class="anchor" href="#can-fully-reproduce-a-performance-from-recorded-signals" aria-hidden="true"><span class="octicon octicon-link"></span></a><em>Can "fully reproduce" a performance from recorded signals</em>
</h4>

<p>Since all the actions of the player on a modern organ is essentially translated to discrete control events, a system that records such actions will be able to "fully reproduce" a performance on the instrument. (This even includes any time-based quantization of the events, which would have been an inherient feature of the many digital control systems during a live performance). This is an interesting philosophical point on a control level. Perhaps, J.S. Bach was referring explicitly to the organ when saying the following:</p>

<p>   <em>"It's easy to play any musical instrument: all you have to do is touch the right key at the right time and the instrument will play itself."</em></p>

<hr>

<h2>
<a id="components-that-may-be-of-interest-for-modelling" class="anchor" href="#components-that-may-be-of-interest-for-modelling" aria-hidden="true"><span class="octicon octicon-link"></span></a>Components that may be of interest for Modelling</h2>

<p>Some of the relevant parts to be modelled by an organ might include:</p>

<ul>
<li><p>Pipes: physical response of the different kinds of pipes (geometry, materials)</p></li>
<li><p>Interaction between pipes (e.g. detuned sets of stops for tremolo effects)</p></li>
<li><p>Imperfections due to environment conditions (e.g. temperature fluctuations)</p></li>
<li><p>Air source: fluctuations in air pressure; physical limits of blowers, tracker actuation</p></li>
<li><p>Reed behaviour</p></li>
<li><p>Control system: coupling, mapping of manuals to different registers</p></li>
<li><p>Reverberance of spaces</p></li>
</ul>

<h3>
<a id="existing-commercial-products" class="anchor" href="#existing-commercial-products" aria-hidden="true"><span class="octicon octicon-link"></span></a>Existing Commercial Products</h3>

<p>One of the more famous virtual software organ systems is <a href="https://www.hauptwerk.com/learn-more/overview/">Hauptwerk</a>. It has an extensive sample-based library of many organs.</p>

<h2>
<a id="implementation" class="anchor" href="#implementation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementation</h2>

<p>This section describes the implementation details of the application implemented for the project.</p>

<p>Development was done in QT, a cross platform C++ development environment</p>

<p>The main components of the software includes:</p>

<ul>
<li>User interface for basic control, visual feedback of status</li>
<li>MIDI interface for reading input from external controller</li>
<li>Synthesis module for producing sound, managing voices

<ul>
<li>STK Voicer class for managing polyphony</li>
<li>Updated every RtAudio tick() and fills output buffer</li>
<li>STK Instruments for different type of "pipes". To start off I inherited from existing classes so that existing functionality can be overridden to be closer to "organ-like" behaviour.</li>
</ul>
</li>
<li>Helper Max/MSP patch for testing without a physical MIDI device</li>
</ul>

<p>The following shows a block diagram of the components of the system
<img src="img/system.png" alt="test "></p>

<h3>
<a id="synthesis-organ-model" class="anchor" href="#synthesis-organ-model" aria-hidden="true"><span class="octicon octicon-link"></span></a>Synthesis: Organ Model</h3>

<p>As described in the previous section, there are two main categories of organ pipes: the flue and the reed.</p>

<p>A first-pass attempt at putting something together, given the existing models in STK might look like:</p>

<p><img src="img/keyboard-flutes.png" alt="keyboard flutes?"></p>

<p>Or, if we're looking at reed pipes:</p>

<p><img src="img/keyboard-clarinet.png" alt="keyboard clarinets?"></p>

<h4>
<a id="flue-pipes-1" class="anchor" href="#flue-pipes-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Flue Pipes</h4>

<p>Since the flue pipe can be seen as a simplier version of a flute, for the implementation I have subclassed the basic flute model in STK with a class called "OrganFlue", and started experimenting with overriding the various internal functions to remove the flute-specific functionalities such as overblowing. (On-going)</p>

<h4>
<a id="reed-pipes-1" class="anchor" href="#reed-pipes-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reed Pipes</h4>

<p>One significant difference between the clarinet and the reed pipes of the organ is that the latter's reeds are tuned to vibrate at the funamental frequency with the pipe length set to resonate around the same frequency, while the clarinet's reed vibrates at a higher frequency than the fundamental of the pitch. Therefore, a reasonable first attempt, given my current understanding of the implementation of the clarinet model in STK, would be to modify the Jet"Table" (not really a table) source to output to the fundamental frequency instead. (On-going)</p>

<hr>

<h3>
<a id="framework-and-realtime-audiomidi-considerations" class="anchor" href="#framework-and-realtime-audiomidi-considerations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Framework and Realtime Audio/MIDI Considerations</h3>

<ul>
<li><p>ASIO drivers were used (in the Windows version) for RtAudio DAC. On Mac the CoreAudio framework is included in the QT project while in Linux alsa is used. These system-dependent settings are configured using platform-specific switches inside the QT .pro project file, which allows the rest of the code base to be identical across systems.</p></li>
<li><p>When there is no external MIDI controller, a virtual MIDI port can be created in RtMidi (OSX and Linux only).</p></li>
<li><p>The Windows MIDI API does not allow for virtual MIDI input devices to be created, which means that if a physical MIDI device is not present, a software loopback MIDI driver (such as <a href="http://www.tobias-erichsen.de/software/loopmidi.html">loopMIDI</a>), must be used. The RtMidi interface must then connect to the virtual loopMIDI port, and then the MIDI output source connected to the same port.</p></li>
<li><p>Testing was done on a desktop PC system, PC Laptop, MacBook laptop, and a virtual ubuntu32 image running inside VirtualBox</p></li>
<li><p>512 buffer size was used. This means at 44100kHz sample rate, we need to compute the 512 samples every ~11ms (also the system latency). This will affect upper limit of polyphony</p></li>
<li>
<p>A very crude sine wave test was done as a "stress test" and suggested there was enough "computational room" to play with.</p>

<ul>
<li>~500 waves on i5 Mobile CPU</li>
<li>~900 waves on i5 Desktop CPU</li>
</ul>
</li>
<li>Actual synthesis is more computationally extensive, but this gives a good ballpark idea</li>
</ul>

<h3>
<a id="demonstration" class="anchor" href="#demonstration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Demonstration</h3>

<p>The program was tested and demonstrated using an <a href="http://www.ionaudio.com/products/details/discover-keyboard-usb">ION Discover</a> mini USB keyboard. It is a simple device with two octaves of velocity sensitive keys. There are 4 additional buttons on the side. Two of them are for octave adjustment, one to activate the sustain pedal message and another modifier key that turn the main keys into increasing program change numbers.</p>

<p align="center">
<img src="http://www.ionaudio.com/images/sized/images/products/disckeyusb_web_black_large-580x363.jpg" alt="ION Discover MIDI Keyboard"><br>
[(img src: ION website)](http://www.ionaudio.com/products/details/discover-keyboard-usb)</p>

<p>A Max/MSP patch (included in the project repository) was created to provide MIDI signals when there is no external controller present. The patch allows connection to the virtual MIDI input port of the synthesizer application, and transmit note and program change messages.</p>

<p align="center">
<img src="img/max_patch.png" alt="Max Test Patch"><br>
Max/MSP text patch</p>

<h3>
<a id="further-development" class="anchor" href="#further-development" aria-hidden="true"><span class="octicon octicon-link"></span></a>Further Development</h3>

<ul>
<li><p>I have only started to play around with the overridden instrument classes, so further investigation for creating more "authentic" organ sounds should be done.</p></li>
<li><p>Modelling other effects such as swell boxes, reverb of different spaces</p></li>
<li><p>Use with more controllers, so multiple stops can be played concurrently on each controller</p></li>
<li><p>Control with non-keyboard controllers</p></li>
</ul>

<h3>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h3>

<p>D. Baker. The Organ : a Brief Guide to its Construction, History, Usage and Music. 1991.</p>

<p>W. H. Clarke. An Outline of the Structure of the Pipe Organ. Oliver Ditson &amp; Co. Boston. 1877.</p>

<h4>
<a id="image-sources" class="anchor" href="#image-sources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Image Sources</h4>

<ul>
<li>Images from Clarke (1877) are public domain.</li>
<li>Images from wikipedia under Creative Commons usage</li>
<li>Image of ION product directly linked to product site (assuming they don't mind the free promotion).</li>
</ul>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/johnty/QtStkPipeOrgan">QtStkPipeOrgan</a> is maintained by <a href="https://github.com/johnty">johnty</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
